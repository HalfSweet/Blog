var mt=Object.defineProperty;var Tt=(n,t,i)=>t in n?mt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i;var A=(n,t,i)=>(Tt(n,typeof t!="symbol"?t+"":t,i),i),Y=(n,t,i)=>{if(!t.has(n))throw TypeError("Cannot "+i)};var e=(n,t,i)=>(Y(n,t,"read from private field"),i?i.call(n):t.get(n)),o=(n,t,i)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,i)},p=(n,t,i,s)=>(Y(n,t,"write to private field"),s?s.call(n,i):t.set(n,i),i);var a=(n,t,i)=>(Y(n,t,"access private method"),i);import{b as wt,k as b,P as xt,p as z,l as Z,t as Dt,E as w,M as bt,a as et,aV as Ct,ag as It,y as At}from"./vidstack-Ds_q5BGO-BmIdNEue.js";import{VideoProvider as _t}from"./vidstack-video-DNbVr-c0.js";import{Q as tt,L as _}from"./vidstack-player-CGtoCiBG.js";import{a as $t,T as it,c as Ht}from"./vidstack-DXXgp8ue-BEqIG_iI.js";import{R as Rt}from"./vidstack-DSYpsFWk-CqqLDmWv.js";import"./vidstack-CGXAe0PE-DSnaatwr.js";import"./app-BvW9zp2N.js";const Ot=n=>At(n);var E,h,r,x,D,g,S,$,st,H,nt,R,rt,O,ot,P,ht,V,at,M,dt,N,ut,k,ct,q,lt,U,pt,j,ft,F,vt,Q,yt;class Pt{constructor(t,i){o(this,g);o(this,$);o(this,H);o(this,R);o(this,O);o(this,P);o(this,V);o(this,M);o(this,N);o(this,k);o(this,q);o(this,U);o(this,j);o(this,F);o(this,Q);o(this,E,void 0);o(this,h,void 0);o(this,r,null);o(this,x,null);A(this,"config",{});o(this,D,new Set);p(this,E,t),p(this,h,i)}get instance(){return e(this,r)}setup(t){const{streamType:i}=e(this,h).$state,s=z(i).includes("live"),c=z(i).includes("ll-");p(this,r,new t({lowLatencyMode:c,backBufferLength:c?4:s?8:void 0,renderTextTracksNatively:!1,...this.config}));const u=a(this,R,rt).bind(this);for(const l of Object.values(t.Events))e(this,r).on(l,u);e(this,r).on(t.Events.ERROR,a(this,q,lt).bind(this));for(const l of e(this,D))l(e(this,r));e(this,h).player.dispatch("hls-instance",{detail:e(this,r)}),e(this,r).attachMedia(e(this,E)),e(this,r).on(t.Events.AUDIO_TRACK_SWITCHED,a(this,V,at).bind(this)),e(this,r).on(t.Events.LEVEL_SWITCHED,a(this,M,dt).bind(this)),e(this,r).on(t.Events.LEVEL_LOADED,a(this,k,ct).bind(this)),e(this,r).on(t.Events.LEVEL_UPDATED,a(this,N,ut).bind(this)),e(this,r).on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,a(this,O,ot).bind(this)),e(this,r).on(t.Events.CUES_PARSED,a(this,P,ht).bind(this)),e(this,h).qualities[tt.enableAuto]=a(this,j,ft).bind(this),Z(e(this,h).qualities,"change",a(this,F,vt).bind(this)),Z(e(this,h).audioTracks,"change",a(this,Q,yt).bind(this)),p(this,x,Dt(a(this,$,st).bind(this)))}onInstance(t){return e(this,D).add(t),()=>e(this,D).delete(t)}loadSource(t){var i;b(t.src)&&((i=e(this,r))==null||i.loadSource(t.src))}destroy(){var t,i;(t=e(this,r))==null||t.destroy(),p(this,r,null),(i=e(this,x))==null||i.call(this),p(this,x,null)}}E=new WeakMap,h=new WeakMap,r=new WeakMap,x=new WeakMap,D=new WeakMap,g=new WeakSet,S=function(t,i){return new w(Ot(t),{detail:i})},$=new WeakSet,st=function(){if(!e(this,h).$state.live())return;const t=new Rt(a(this,H,nt).bind(this));return t.start(),t.stop.bind(t)},H=new WeakSet,nt=function(){var t;e(this,h).$state.liveSyncPosition.set(((t=e(this,r))==null?void 0:t.liveSyncPosition)??1/0)},R=new WeakSet,rt=function(t,i){var s;(s=e(this,h).player)==null||s.dispatch(a(this,g,S).call(this,t,i))},O=new WeakSet,ot=function(t,i){const s=a(this,g,S).call(this,t,i);let c=-1;for(let u=0;u<i.tracks.length;u++){const l=i.tracks[u],d=l.subtitleTrack??l.closedCaptions,T=new $t({id:`hls-${l.kind}-${u}`,src:d==null?void 0:d.url,label:l.label,language:d==null?void 0:d.lang,kind:l.kind,default:l.default});T[it.readyState]=2,T[it.onModeChange]=()=>{T.mode==="showing"?(e(this,r).subtitleTrack=u,c=u):c===u&&(e(this,r).subtitleTrack=-1,c=-1)},e(this,h).textTracks.add(T,s)}},P=new WeakSet,ht=function(t,i){var l;const s=(l=e(this,r))==null?void 0:l.subtitleTrack,c=e(this,h).textTracks.getById(`hls-${i.type}-${s}`);if(!c)return;const u=a(this,g,S).call(this,t,i);for(const d of i.cues)d.positionAlign="auto",c.addCue(d,u)},V=new WeakSet,at=function(t,i){const s=e(this,h).audioTracks[i.id];if(s){const c=a(this,g,S).call(this,t,i);e(this,h).audioTracks[_.select](s,!0,c)}},M=new WeakSet,dt=function(t,i){const s=e(this,h).qualities[i.level];if(s){const c=a(this,g,S).call(this,t,i);e(this,h).qualities[_.select](s,!0,c)}},N=new WeakSet,ut=function(t,i){i.details.totalduration>0&&e(this,h).$state.inferredLiveDVRWindow.set(i.details.totalduration)},k=new WeakSet,ct=function(t,i){var G;if(e(this,h).$state.canPlay())return;const{type:s,live:c,totalduration:u,targetduration:l}=i.details,d=a(this,g,S).call(this,t,i);e(this,h).notify("stream-type-change",c?s==="EVENT"&&Number.isFinite(u)&&l>=10?"live:dvr":"live":"on-demand",d),e(this,h).notify("duration-change",u,d);const T=e(this,r).media;e(this,r).currentLevel===-1&&e(this,h).qualities[tt.setAuto](!0,d);for(const v of e(this,r).audioTracks){const X={id:v.id.toString(),label:v.name,language:v.lang||"",kind:"main"};e(this,h).audioTracks[_.add](X,d)}for(const v of e(this,r).levels){const X={id:((G=v.id)==null?void 0:G.toString())??v.height+"p",width:v.width,height:v.height,codec:v.codecSet,bitrate:v.bitrate};e(this,h).qualities[_.add](X,d)}T.dispatchEvent(new w("canplay",{trigger:d}))},q=new WeakSet,lt=function(t,i){var s;if(i.fatal)switch(i.type){case"mediaError":(s=e(this,r))==null||s.recoverMediaError();break;default:a(this,U,pt).call(this,i.error);break}},U=new WeakSet,pt=function(t){e(this,h).notify("error",{message:t.message,code:1,error:t})},j=new WeakSet,ft=function(){e(this,r)&&(e(this,r).currentLevel=-1)},F=new WeakSet,vt=function(){const{qualities:t}=e(this,h);!e(this,r)||t.auto||(e(this,r)[t.switch+"Level"]=t.selectedIndex,bt&&(e(this,E).currentTime=e(this,E).currentTime))},Q=new WeakSet,yt=function(){const{audioTracks:t}=e(this,h);e(this,r)&&e(this,r).audioTrack!==t.selectedIndex&&(e(this,r).audioTrack=t.selectedIndex)};var m,y,C,K,gt,W,Lt,B,St,J,Et;class Vt{constructor(t,i,s){o(this,K);o(this,W);o(this,B);o(this,J);o(this,m,void 0);o(this,y,void 0);o(this,C,void 0);p(this,m,t),p(this,y,i),p(this,C,s),a(this,K,gt).call(this)}}m=new WeakMap,y=new WeakMap,C=new WeakMap,K=new WeakSet,gt=async function(){const t={onLoadStart:a(this,W,Lt).bind(this),onLoaded:a(this,B,St).bind(this),onLoadError:a(this,J,Et).bind(this)};let i=await Nt(e(this,m),t);if(et(i)&&!b(e(this,m))&&(i=await Mt(e(this,m),t)),!i)return null;if(!i.isSupported()){const s="[vidstack] `hls.js` is not supported in this environment";return e(this,y).player.dispatch(new w("hls-unsupported")),e(this,y).notify("error",{message:s,code:4}),null}return i},W=new WeakSet,Lt=function(){e(this,y).player.dispatch(new w("hls-lib-load-start"))},B=new WeakSet,St=function(t){e(this,y).player.dispatch(new w("hls-lib-loaded",{detail:t})),e(this,C).call(this,t)},J=new WeakSet,Et=function(t){const i=Ht(t);e(this,y).player.dispatch(new w("hls-lib-load-error",{detail:i})),e(this,y).notify("error",{message:i.message,code:4,error:i})};async function Mt(n,t={}){var i,s,c,u,l;if(!et(n)){if((i=t.onLoadStart)==null||i.call(t),n.prototype&&n.prototype!==Function)return(s=t.onLoaded)==null||s.call(t,n),n;try{const d=(c=await n())==null?void 0:c.default;if(d&&d.isSupported)(u=t.onLoaded)==null||u.call(t,d);else throw Error("");return d}catch(d){(l=t.onLoadError)==null||l.call(t,d)}}}async function Nt(n,t={}){var i,s,c;if(b(n)){(i=t.onLoadStart)==null||i.call(t);try{if(await Ct(n),!It(window.Hls))throw Error("");const u=window.Hls;return(s=t.onLoaded)==null||s.call(t,u),u}catch(u){(c=t.onLoadError)==null||c.call(t,u)}}}const kt="https://cdn.jsdelivr.net";var I,f,L;class qt extends _t{constructor(){super(...arguments);A(this,"$$PROVIDER_TYPE","HLS");o(this,I,null);o(this,f,new Pt(this.video,this.ctx));o(this,L,`${kt}/npm/hls.js@^1.5.0/dist/hls.min.js`)}get ctor(){return e(this,I)}get instance(){return e(this,f).instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return e(this,f).config}set config(i){e(this,f).config=i}get library(){return e(this,L)}set library(i){p(this,L,i)}preconnect(){b(e(this,L))&&xt(e(this,L))}setup(){super.setup(),new Vt(e(this,L),this.ctx,i=>{p(this,I,i),e(this,f).setup(i),this.ctx.notify("provider-setup",this);const s=z(this.ctx.$state.source);s&&this.loadSource(s)})}async loadSource(i,s){if(!b(i.src)){this.removeSource();return}this.media.preload=s||"",this.appendSource(i,"application/x-mpegurl"),e(this,f).loadSource(i),this.currentSrc=i}onInstance(i){const s=e(this,f).instance;return s&&i(s),e(this,f).onInstance(i)}destroy(){e(this,f).destroy()}}I=new WeakMap,f=new WeakMap,L=new WeakMap,A(qt,"supported",wt());export{qt as HLSProvider};
